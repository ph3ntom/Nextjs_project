# 포인트 업데이트 문제 분석 및 해결방안

## 🔍 현재 상황 분석

### 1. 서버 응답 확인 ✅
**API**: `POST /coupons/use`
**응답 예시**:
```json
{
  "success": true,
  "message": "100 포인트가 충전되었습니다.",
  "newPoints": 610
}
```
- 서버는 올바르게 업데이트된 포인트(`newPoints`)를 반환하고 있음

### 2. 프론트엔드 구현 현황

#### A. AuthContext 구조
```typescript
interface User {
  userId: string
  sessionId: string
  mbrId: number
  points?: number  // 선택적 속성
}

const updatePoints = (newPoints: number) => {
  if (user) {
    setUser({ ...user, points: newPoints })
  }
}
```

#### B. PointShop 구현
```typescript
const { user, isLoggedIn, updatePoints } = useAuth()
const userPoints = user?.points || 0

// 쿠폰 사용 성공 시
updatePoints(result.newPoints)
```

## 🐛 예상 문제점들

### 1. AuthContext 초기화 문제
**문제**: localStorage에서 불러온 사용자 정보에 `points` 속성이 없을 수 있음
```typescript
// useEffect에서 localStorage 로드 시
const storedUser = localStorage.getItem('user')
setUser(JSON.parse(storedUser)) // points 속성이 없을 수 있음
```

### 2. React 상태 업데이트 지연
**문제**: `setUser` 호출 후 즉시 반영되지 않을 수 있음

### 3. 로그인 시 points 초기값 문제
**문제**: 로그인 시 서버에서 `point`를 받지만 `points`로 저장됨

## 🔧 해결방안

### 방안 1: 서버에서 최신 포인트 재조회
```typescript
const refreshUserPoints = async () => {
  try {
    const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/users/${user?.mbrId}/points`)
    if (response.ok) {
      const data = await response.json()
      updatePoints(data.points)
    }
  } catch (error) {
    console.error('포인트 조회 실패:', error)
  }
}

// 쿠폰 사용 후 호출
await refreshUserPoints()
```

### 방안 2: 로그인 시 포인트 정보 확실히 저장
```typescript
// 로그인 시
login({
  userId: data.userId,
  sessionId: data.sessionId,
  mbrId: data.mbrId,
  points: data.point || 0  // 확실히 저장
});
```

### 방안 3: 강제 리렌더링
```typescript
// 상태 변경 강제
const [pointsVersion, setPointsVersion] = useState(0)

// 쿠폰 사용 후
updatePoints(result.newPoints)
setPointsVersion(prev => prev + 1) // 강제 리렌더링
```

## 🚨 권장 해결방법

**1단계**: AuthContext 초기화 시 points 기본값 설정
**2단계**: 쿠폰 사용 후 서버에서 최신 포인트 재조회
**3단계**: 로그인 시 points 값 확실히 저장

이 방법들을 순차적으로 적용하면 포인트 업데이트 문제가 해결될 것입니다.